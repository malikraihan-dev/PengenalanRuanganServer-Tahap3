<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RuangServer - Monitor Akses Server</title>
    <!-- face-api.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');

        :root {
            --bg-primary: #0a0e27;
            --bg-secondary: #111536;
            --bg-card: rgba(255,255,255,0.05);
            --glass: rgba(255,255,255,0.08);
            --glass-border: rgba(255,255,255,0.12);
            --accent: #6366f1;
            --accent-light: #818cf8;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --text-primary: #f1f5f9;
            --text-secondary: rgba(241,245,249,0.6);
            --text-muted: rgba(241,245,249,0.35);
            --shadow: 0 8px 32px rgba(0,0,0,0.3);
            --radius: 16px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated gradient background */
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 20% 20%, rgba(99,102,241,0.15) 0%, transparent 40%),
                        radial-gradient(circle at 80% 80%, rgba(139,92,246,0.1) 0%, transparent 40%),
                        radial-gradient(circle at 50% 50%, rgba(59,130,246,0.08) 0%, transparent 50%);
            animation: bgShift 20s ease-in-out infinite;
            z-index: 0;
        }

        @keyframes bgShift {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(-5%, -5%) rotate(2deg); }
            66% { transform: translate(5%, 5%) rotate(-2deg); }
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            position: fixed;
            left: 0; top: 0;
            width: 72px;
            height: 100vh;
            background: rgba(10,14,39,0.95);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--glass-border);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px 0;
            transition: width 0.3s;
        }

        .sidebar:hover { width: 240px; }

        .sidebar .logo {
            width: 44px; height: 44px;
            background: linear-gradient(135deg, var(--accent), #a855f7);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-bottom: 32px;
            flex-shrink: 0;
        }

        .sidebar .nav-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
            padding: 0 12px;
        }

        .sidebar .nav-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 12px;
            border-radius: 12px;
            color: var(--text-secondary);
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            overflow: hidden;
        }

        .sidebar .nav-item:hover, .sidebar .nav-item.active {
            background: var(--glass);
            color: var(--text-primary);
        }

        .sidebar .nav-item.active {
            background: rgba(99,102,241,0.2);
            color: var(--accent-light);
        }

        .sidebar .nav-icon {
            min-width: 24px;
            text-align: center;
            font-size: 18px;
        }

        .sidebar .nav-label {
            font-size: 13px;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .sidebar:hover .nav-label { opacity: 1; }

        /* ===== MAIN CONTENT ===== */
        .main-content {
            margin-left: 72px;
            padding: 24px 32px;
            position: relative;
            z-index: 1;
            min-height: 100vh;
        }

        /* ===== HEADER ===== */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 28px;
        }

        .header-left h1 {
            font-size: 26px;
            font-weight: 800;
            letter-spacing: -0.5px;
            background: linear-gradient(135deg, #f1f5f9, #94a3b8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-left p {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .clock {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            padding: 10px 20px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }

        .clock .time { color: var(--accent-light); font-size: 18px; }
        .clock .date { color: var(--text-muted); font-size: 11px; margin-top: 2px; }

        .user-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            padding: 8px 16px;
            border-radius: 12px;
            cursor: pointer;
        }

        .user-avatar {
            width: 36px; height: 36px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--accent), #a855f7);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 700;
        }

        .user-info { font-size: 13px; }
        .user-info .name { font-weight: 600; }
        .user-info .role {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--accent-light);
        }

        /* ===== GLASS CARD ===== */
        .glass-card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.4);
        }

        /* ===== STATS GRID ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            border-radius: var(--radius) var(--radius) 0 0;
        }

        .stat-card.camera::before { background: linear-gradient(90deg, var(--success), #34d399); }
        .stat-card.users::before { background: linear-gradient(90deg, var(--info), #60a5fa); }
        .stat-card.admins::before { background: linear-gradient(90deg, var(--accent), #a78bfa); }
        .stat-card.granted::before { background: linear-gradient(90deg, var(--success), #86efac); }
        .stat-card.denied::before { background: linear-gradient(90deg, var(--danger), #fca5a5); }
        .stat-card.total::before { background: linear-gradient(90deg, var(--warning), #fbbf24); }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .stat-icon {
            width: 40px; height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .stat-card.camera .stat-icon { background: rgba(34,197,94,0.15); color: var(--success); }
        .stat-card.users .stat-icon { background: rgba(59,130,246,0.15); color: var(--info); }
        .stat-card.admins .stat-icon { background: rgba(99,102,241,0.15); color: var(--accent-light); }
        .stat-card.granted .stat-icon { background: rgba(34,197,94,0.15); color: var(--success); }
        .stat-card.denied .stat-icon { background: rgba(239,68,68,0.15); color: var(--danger); }
        .stat-card.total .stat-icon { background: rgba(245,158,11,0.15); color: var(--warning); }

        .stat-value {
            font-size: 32px;
            font-weight: 800;
            letter-spacing: -1px;
        }

        .stat-sub {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* ===== MAIN GRID (Camera + Profile) ===== */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        /* ===== CAMERA SECTION ===== */
        .camera-section {
            position: relative;
        }

        .camera-section h3 {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .camera-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 600;
        }

        .camera-status.active {
            background: rgba(34,197,94,0.15);
            color: var(--success);
        }

        .camera-status.inactive {
            background: rgba(239,68,68,0.15);
            color: var(--danger);
        }

        .camera-status .dot {
            width: 6px; height: 6px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .camera-status.active .dot { background: var(--success); }
        .camera-status.inactive .dot { background: var(--danger); animation: none; }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.5); }
        }

        .camera-container {
            position: relative;
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
            background: #000;
            aspect-ratio: 4/3;
        }

        #videoElement {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        .camera-overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        /* Face detection canvas */
        #overlayCanvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            transform: scaleX(-1);
        }

        .scan-line {
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent-light), transparent);
            animation: scanDown 3s ease-in-out infinite;
        }

        @keyframes scanDown {
            0% { top: 0; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        .camera-controls {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), #7c3aed);
            color: white;
        }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(99,102,241,0.4); }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #16a34a);
            color: white;
        }
        .btn-success:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(34,197,94,0.4); }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #dc2626);
            color: white;
        }
        .btn-danger:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(239,68,68,0.4); }

        .btn-ghost {
            background: var(--glass);
            color: var(--text-primary);
            border: 1px solid var(--glass-border);
        }
        .btn-ghost:hover { background: rgba(255,255,255,0.12); }

        .btn-sm { padding: 6px 14px; font-size: 12px; }

        /* ===== PROFILE / DETECTION RESULT ===== */
        .profile-section h3 {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .profile-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            color: var(--text-muted);
            text-align: center;
        }

        .profile-placeholder .icon {
            font-size: 60px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .profile-card {
            display: none;
            animation: slideUp 0.5s ease-out;
        }

        .profile-card.show { display: block; }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--glass-border);
        }

        .profile-photo {
            width: 80px; height: 80px;
            border-radius: 16px;
            background: linear-gradient(135deg, var(--accent), #a855f7);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: 800;
            overflow: hidden;
        }

        .profile-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-info h4 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .profile-info .nim {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .profile-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 8px;
        }

        .badge-admin {
            background: rgba(168,85,247,0.2);
            color: #c084fc;
        }

        .badge-user {
            background: rgba(59,130,246,0.2);
            color: #93c5fd;
        }

        .profile-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .detail-item {
            background: rgba(255,255,255,0.03);
            padding: 14px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.06);
        }

        .detail-item .label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .detail-item .value {
            font-size: 16px;
            font-weight: 700;
        }

        .access-result {
            margin-top: 16px;
            padding: 16px;
            border-radius: 12px;
            display: none;
            animation: fadeIn 0.3s ease-out;
        }

        .access-result.show { display: flex; gap: 12px; align-items: center; }

        .access-result.granted {
            background: rgba(34,197,94,0.12);
            border: 1px solid rgba(34,197,94,0.3);
        }

        .access-result.denied {
            background: rgba(239,68,68,0.12);
            border: 1px solid rgba(239,68,68,0.3);
        }

        .access-icon {
            width: 48px; height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .granted .access-icon { background: rgba(34,197,94,0.2); }
        .denied .access-icon { background: rgba(239,68,68,0.2); }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ===== BOTTOM GRID ===== */
        .bottom-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        /* ===== LOG TABLE ===== */
        .log-section h3, .chart-section h3 {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .log-table {
            width: 100%;
            border-collapse: collapse;
        }

        .log-table th {
            text-align: left;
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 12px 14px;
            border-bottom: 1px solid var(--glass-border);
            font-weight: 600;
        }

        .log-table td {
            padding: 12px 14px;
            font-size: 13px;
            border-bottom: 1px solid rgba(255,255,255,0.04);
        }

        .log-table tr:hover td {
            background: rgba(255,255,255,0.03);
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .status-granted {
            background: rgba(34,197,94,0.15);
            color: var(--success);
        }

        .status-denied {
            background: rgba(239,68,68,0.15);
            color: var(--danger);
        }

        /* ===== CHART ===== */
        .chart-container {
            height: 280px;
            position: relative;
        }

        /* ===== ADMIN PANEL ===== */
        .admin-panel {
            display: none;
            margin-bottom: 24px;
        }

        .admin-panel.show { display: block; }

        .admin-panel h3 {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-list-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
        }

        .user-card {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 12px;
            transition: all 0.2s;
        }

        .user-card:hover {
            background: rgba(255,255,255,0.06);
            border-color: var(--glass-border);
        }

        .user-card .avatar {
            width: 44px; height: 44px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            flex-shrink: 0;
        }

        .user-card .avatar.admin-avatar { background: linear-gradient(135deg, #7c3aed, #a855f7); }
        .user-card .avatar.user-avatar { background: linear-gradient(135deg, #2563eb, #3b82f6); }

        .user-card .user-details { flex: 1; }
        .user-card .user-name { font-weight: 600; font-size: 14px; }
        .user-card .user-nim { font-size: 12px; color: var(--text-muted); }

        .user-card .actions {
            display: flex;
            gap: 6px;
        }

        .role-select {
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            background: var(--glass);
            color: var(--text-primary);
            font-size: 12px;
            font-family: 'Inter', sans-serif;
            cursor: pointer;
        }

        /* ===== NOTIFICATIONS ===== */
        .notification-toast {
            position: fixed;
            top: 24px;
            right: 24px;
            min-width: 340px;
            padding: 16px 20px;
            border-radius: 12px;
            backdrop-filter: blur(20px);
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.4s ease-out;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            cursor: pointer;
        }

        .notification-toast.success {
            background: rgba(34,197,94,0.15);
            border: 1px solid rgba(34,197,94,0.3);
        }

        .notification-toast.error {
            background: rgba(239,68,68,0.15);
            border: 1px solid rgba(239,68,68,0.3);
        }

        .notification-toast.info {
            background: rgba(59,130,246,0.15);
            border: 1px solid rgba(59,130,246,0.3);
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* ===== LOADING OVERLAY ===== */
        .loading-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(10,14,39,0.9);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 10000;
        }

        .loading-overlay.hidden { display: none; }

        .spinner {
            width: 50px; height: 50px;
            border: 3px solid var(--glass-border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* ===== FACE DETECTED ANIMATION ===== */
        .face-detected-anim {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 120px; height: 120px;
            border: 3px solid var(--success);
            border-radius: 20px;
            opacity: 0;
            pointer-events: none;
        }

        .face-detected-anim.active {
            animation: faceDetect 1s ease-out;
        }

        @keyframes faceDetect {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); }
            30% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            70% { opacity: 1; }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }

        /* ===== SCROLLBAR ===== */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--glass-border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

        /* ===== LOG SECTION SCROLL ===== */
        .log-scroll {
            max-height: 360px;
            overflow-y: auto;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 1024px) {
            .main-grid, .bottom-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(3, 1fr); }
        }

        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; padding: 16px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .header { flex-direction: column; gap: 12px; align-items: flex-start; }
            .profile-details { grid-template-columns: 1fr; }
        }

        /* ===== MODAL ===== */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(8px);
            z-index: 5000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.show { display: flex; }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 32px;
            min-width: 420px;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            animation: modalIn 0.3s ease-out;
        }

        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.9) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .modal h3 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            border-color: var(--accent);
        }

        .form-select {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            cursor: pointer;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 24px;
        }

        .modal-actions .btn { flex: 1; justify-content: center; }
    </style>
</head>
<body>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div class="loading-text">Memuat Face Recognition Model...</div>
</div>

<!-- Sidebar -->
<nav class="sidebar">
    <div class="logo">&#128421;</div>
    <div class="nav-items">
        <a href="/" class="nav-item">
            <span class="nav-icon">&#127968;</span>
            <span class="nav-label">Dashboard Utama</span>
        </a>
        <a href="/server-monitor" class="nav-item active">
            <span class="nav-icon">&#128200;</span>
            <span class="nav-label">Monitor Server</span>
        </a>
        <a href="/server-monitor-register" class="nav-item">
            <span class="nav-icon">&#128100;</span>
            <span class="nav-label">Register Wajah</span>
        </a>
        <a href="/face-register" class="nav-item">
            <span class="nav-icon">&#128248;</span>
            <span class="nav-label">Face Register</span>
        </a>
        <a href="/face-absensi" class="nav-item">
            <span class="nav-icon">&#128247;</span>
            <span class="nav-label">Absensi Wajah</span>
        </a>
        <a href="/chatbot" class="nav-item">
            <span class="nav-icon">&#129302;</span>
            <span class="nav-label">Chatbot</span>
        </a>
        <a href="/user-management" class="nav-item">
            <span class="nav-icon">&#128101;</span>
            <span class="nav-label">User Panel</span>
        </a>
        <div style="flex:1"></div>
        <a class="nav-item" onclick="logout()">
            <span class="nav-icon">&#128682;</span>
            <span class="nav-label">Logout</span>
        </a>
    </div>
</nav>

<!-- Main Content -->
<div class="main-content">
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <h1>&#128274; Server Room Monitor</h1>
            <p>AI-Powered Face Recognition Access Control System</p>
        </div>
        <div class="header-right">
            <div class="clock" id="clockWidget">
                <div class="time" id="clockTime">--:--:--</div>
                <div class="date" id="clockDate">Loading...</div>
            </div>
            <div class="user-badge" id="userBadge" style="display:none;">
                <div class="user-avatar" id="userAvatarSmall">?</div>
                <div class="user-info">
                    <div class="name" id="userNameSmall">-</div>
                    <div class="role" id="userRoleSmall">-</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid">
        <div class="glass-card stat-card camera">
            <div class="stat-header">
                <span class="stat-label">Status Kamera</span>
                <div class="stat-icon">&#127909;</div>
            </div>
            <div class="stat-value" id="statCamera" style="font-size:20px;">
                <span class="camera-status inactive" id="cameraStatusBadge">
                    <span class="dot"></span> Tidak Aktif
                </span>
            </div>
            <div class="stat-sub">Webcam face detection</div>
        </div>
        <div class="glass-card stat-card users">
            <div class="stat-header">
                <span class="stat-label">User Terdaftar</span>
                <div class="stat-icon">&#128101;</div>
            </div>
            <div class="stat-value" id="statUsers">0</div>
            <div class="stat-sub">Total pengguna aktif</div>
        </div>
        <div class="glass-card stat-card admins">
            <div class="stat-header">
                <span class="stat-label">Administrator</span>
                <div class="stat-icon">&#128081;</div>
            </div>
            <div class="stat-value" id="statAdmins">0</div>
            <div class="stat-sub">Hak akses penuh</div>
        </div>
        <div class="glass-card stat-card granted">
            <div class="stat-header">
                <span class="stat-label">Akses Diterima</span>
                <div class="stat-icon">&#9989;</div>
            </div>
            <div class="stat-value" id="statGranted">0</div>
            <div class="stat-sub">Hari ini (GRANTED)</div>
        </div>
        <div class="glass-card stat-card denied">
            <div class="stat-header">
                <span class="stat-label">Akses Ditolak</span>
                <div class="stat-icon">&#10060;</div>
            </div>
            <div class="stat-value" id="statDenied">0</div>
            <div class="stat-sub">Hari ini (DENIED)</div>
        </div>
        <div class="glass-card stat-card total">
            <div class="stat-header">
                <span class="stat-label">Total Akses</span>
                <div class="stat-icon">&#128202;</div>
            </div>
            <div class="stat-value" id="statTotal">0</div>
            <div class="stat-sub">Hari ini</div>
        </div>
    </div>

    <!-- Main Grid: Camera & Profile -->
    <div class="main-grid">
        <!-- Camera -->
        <div class="glass-card camera-section">
            <h3>
                &#127909; Live Camera
                <span class="camera-status active" id="cameraStatusInline" style="display:none;">
                    <span class="dot"></span> Aktif
                </span>
            </h3>
            <div class="camera-container" id="cameraContainer">
                <video id="videoElement" autoplay muted playsinline></video>
                <canvas id="overlayCanvas"></canvas>
                <div class="scan-line" id="scanLine" style="display:none;"></div>
                <div class="face-detected-anim" id="faceDetectedAnim"></div>
            </div>
            <div class="camera-controls">
                <button class="btn btn-primary" id="btnStartCamera" onclick="startCamera()">
                    &#127909; Mulai Kamera
                </button>
                <button class="btn btn-danger" id="btnStopCamera" onclick="stopCamera()" style="display:none;">
                    &#9724; Stop
                </button>
                <button class="btn btn-success" id="btnVerify" onclick="verifyFace()" style="display:none;">
                    &#128275; Verifikasi
                </button>
                <button class="btn btn-ghost btn-sm" onclick="captureSnapshot()">
                    &#128247; Snapshot
                </button>
            </div>
        </div>

        <!-- Profile / Detection Result -->
        <div class="glass-card profile-section">
            <h3>&#128100; Identifikasi</h3>

            <!-- Placeholder -->
            <div class="profile-placeholder" id="profilePlaceholder">
                <div class="icon">&#128373;</div>
                <p style="font-size:14px; margin-bottom:8px;">Menunggu deteksi wajah...</p>
                <p style="font-size:12px;">Arahkan wajah ke kamera untuk memulai verifikasi</p>
            </div>

            <!-- Profile Card -->
            <div class="profile-card" id="profileCard">
                <div class="profile-header">
                    <div class="profile-photo" id="profilePhoto">?</div>
                    <div class="profile-info">
                        <h4 id="profileName">-</h4>
                        <div class="nim" id="profileNim">NIM: -</div>
                        <span class="profile-badge badge-user" id="profileBadge">USER</span>
                    </div>
                </div>
                <div class="profile-details">
                    <div class="detail-item">
                        <div class="label">Confidence</div>
                        <div class="value" id="profileConfidence" style="color:var(--success);">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="label">Status</div>
                        <div class="value" id="profileStatus">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="label">Waktu Akses</div>
                        <div class="value" id="profileTime" style="font-size:14px;">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="label">Total Foto</div>
                        <div class="value" id="profileFaceCount">-</div>
                    </div>
                </div>
                <div class="access-result granted" id="accessGranted">
                    <div class="access-icon">&#9989;</div>
                    <div>
                        <div style="font-weight:700; color:var(--success);">AKSES DIBERIKAN</div>
                        <div style="font-size:12px; color:var(--text-secondary);" id="grantedMessage">Verifikasi wajah berhasil</div>
                    </div>
                </div>
                <div class="access-result denied" id="accessDenied">
                    <div class="access-icon">&#10060;</div>
                    <div>
                        <div style="font-weight:700; color:var(--danger);">AKSES DITOLAK</div>
                        <div style="font-size:12px; color:var(--text-secondary);" id="deniedMessage">Verifikasi gagal</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel (hidden until admin verified) -->
    <div class="glass-card admin-panel" id="adminPanel">
        <h3>&#128081; Panel Admin - Kelola User
            <button class="btn btn-primary btn-sm" onclick="openRegisterModal()">+ Tambah User</button>
        </h3>
        <div class="user-list-grid" id="adminUserList">
            <!-- Filled by JS -->
        </div>
    </div>

    <!-- Bottom Grid: Logs + Chart -->
    <div class="bottom-grid">
        <!-- Access Logs -->
        <div class="glass-card log-section">
            <h3>
                &#128203; Log Aktivitas Akses
                <button class="btn btn-ghost btn-sm" onclick="refreshLogs()">&#128260; Refresh</button>
            </h3>
            <div class="log-scroll">
                <table class="log-table">
                    <thead>
                        <tr>
                            <th>Waktu</th>
                            <th>Nama</th>
                            <th>NIM</th>
                            <th>Status</th>
                            <th>Confidence</th>
                        </tr>
                    </thead>
                    <tbody id="logTableBody">
                        <tr><td colspan="5" style="text-align:center; color:var(--text-muted);">Memuat log...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Chart -->
        <div class="glass-card chart-section">
            <h3>&#128200; Statistik Akses Harian</h3>
            <div class="chart-container">
                <canvas id="accessChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Register Modal -->
<div class="modal-overlay" id="registerModal">
    <div class="modal">
        <h3>&#128100; Registrasi User Baru</h3>
        <div class="form-group">
            <label>NIM</label>
            <input type="text" class="form-input" id="regNim" placeholder="Masukkan NIM">
        </div>
        <div class="form-group">
            <label>Nama Lengkap</label>
            <input type="text" class="form-input" id="regNama" placeholder="Masukkan nama lengkap">
        </div>
        <div class="form-group">
            <label>Role</label>
            <select class="form-select" id="regRole">
                <option value="USER">USER</option>
                <option value="ADMIN">ADMIN</option>
            </select>
        </div>
        <div class="modal-actions">
            <button class="btn btn-ghost" onclick="closeRegisterModal()">Batal</button>
            <button class="btn btn-primary" onclick="registerFromModal()">&#128190; Daftar</button>
        </div>
    </div>
</div>

<script>
    // ===================== GLOBAL STATE =====================
    const API_BASE = '/api/monitor';
    let currentUser = null;
    let jwtToken = localStorage.getItem('monitor_token');
    let stream = null;
    let faceDetectionInterval = null;
    let labeledDescriptors = [];
    let faceMatcher = null;
    let isModelLoaded = false;
    let cameraActive = false;

    // ===================== INIT =====================
    document.addEventListener('DOMContentLoaded', async () => {
        updateClock();
        setInterval(updateClock, 1000);
        loadStats();
        refreshLogs();
        loadChart();

        // Check existing token
        if (jwtToken) {
            try {
                const payload = JSON.parse(atob(jwtToken.split('.')[1]));
                if (payload.exp * 1000 > Date.now()) {
                    currentUser = { nim: payload.nim, nama: payload.nama, role: payload.role };
                    showUserBadge(currentUser);
                    if (currentUser.role === 'ADMIN') {
                        loadAdminPanel();
                    }
                } else {
                    localStorage.removeItem('monitor_token');
                    jwtToken = null;
                }
            } catch (e) {
                localStorage.removeItem('monitor_token');
                jwtToken = null;
            }
        }

        // Load face-api models
        await loadFaceModels();
    });

    // ===================== CLOCK =====================
    function updateClock() {
        const now = new Date();
        const days = ['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'];
        const months = ['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agu','Sep','Okt','Nov','Des'];
        document.getElementById('clockTime').textContent =
            now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        document.getElementById('clockDate').textContent =
            `${days[now.getDay()]}, ${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}`;
    }

    // ===================== FACE-API MODELS =====================
    async function loadFaceModels() {
        const overlay = document.getElementById('loadingOverlay');
        try {
            const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@master/weights';
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
                faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL),
                faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL)
            ]);
            isModelLoaded = true;
            overlay.classList.add('hidden');
            console.log('Face-api models loaded!');
            await loadLabeledDescriptors();
        } catch (err) {
            console.error('Error loading models:', err);
            overlay.querySelector('.loading-text').textContent = 'Gagal memuat model. Refresh halaman.';
        }
    }

    // ===================== LOAD LABELED DESCRIPTORS =====================
    async function loadLabeledDescriptors() {
        try {
            const res = await fetch('/api/face/all');
            const faceDataList = await res.json();

            if (!faceDataList || faceDataList.length === 0) {
                console.log('No face data available for matching.');
                return;
            }

            // Group by NIM
            const grouped = {};
            faceDataList.forEach(fd => {
                if (!grouped[fd.nim]) {
                    grouped[fd.nim] = { label: fd.label || fd.nim, descriptors: [] };
                }
                try {
                    const desc = JSON.parse(fd.faceDescriptor);
                    grouped[fd.nim].descriptors.push(new Float32Array(desc));
                } catch (e) {
                    console.warn('Invalid descriptor for:', fd.nim);
                }
            });

            labeledDescriptors = Object.entries(grouped).map(([nim, data]) => {
                return new faceapi.LabeledFaceDescriptors(nim, data.descriptors);
            });

            if (labeledDescriptors.length > 0) {
                faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.5);
                console.log('FaceMatcher ready with', labeledDescriptors.length, 'identities.');
            }
        } catch (err) {
            console.error('Error loading descriptors:', err);
        }
    }

    // ===================== CAMERA =====================
    async function startCamera() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({
                video: { width: 640, height: 480, facingMode: 'user' }
            });
            const video = document.getElementById('videoElement');
            video.srcObject = stream;
            cameraActive = true;

            document.getElementById('btnStartCamera').style.display = 'none';
            document.getElementById('btnStopCamera').style.display = '';
            document.getElementById('btnVerify').style.display = '';
            document.getElementById('scanLine').style.display = '';
            document.getElementById('cameraStatusInline').style.display = '';

            // Update status badge
            const badge = document.getElementById('cameraStatusBadge');
            badge.className = 'camera-status active';
            badge.innerHTML = '<span class="dot"></span> Aktif';

            // Start face detection loop
            video.addEventListener('playing', () => {
                const canvas = document.getElementById('overlayCanvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                startFaceDetection();
            });

            showNotification('Kamera berhasil diaktifkan', 'success');
        } catch (err) {
            console.error('Camera error:', err);
            showNotification('Gagal mengakses kamera: ' + err.message, 'error');
        }
    }

    function stopCamera() {
        if (stream) {
            stream.getTracks().forEach(t => t.stop());
            stream = null;
        }
        if (faceDetectionInterval) {
            clearInterval(faceDetectionInterval);
            faceDetectionInterval = null;
        }
        cameraActive = false;

        document.getElementById('videoElement').srcObject = null;
        document.getElementById('btnStartCamera').style.display = '';
        document.getElementById('btnStopCamera').style.display = 'none';
        document.getElementById('btnVerify').style.display = 'none';
        document.getElementById('scanLine').style.display = 'none';
        document.getElementById('cameraStatusInline').style.display = 'none';

        const badge = document.getElementById('cameraStatusBadge');
        badge.className = 'camera-status inactive';
        badge.innerHTML = '<span class="dot"></span> Tidak Aktif';

        // Clear canvas
        const canvas = document.getElementById('overlayCanvas');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    // ===================== FACE DETECTION LOOP =====================
    function startFaceDetection() {
        if (faceDetectionInterval) clearInterval(faceDetectionInterval);

        const video = document.getElementById('videoElement');
        const canvas = document.getElementById('overlayCanvas');

        faceDetectionInterval = setInterval(async () => {
            if (!cameraActive || !isModelLoaded) return;

            const detections = await faceapi
                .detectAllFaces(video, new faceapi.TinyFaceDetectorOptions({ inputSize: 320, scoreThreshold: 0.5 }))
                .withFaceLandmarks()
                .withFaceDescriptors()
                .withFaceExpressions();

            // Resize results to display size
            const displaySize = { width: video.videoWidth, height: video.videoHeight };
            faceapi.matchDimensions(canvas, displaySize);
            const resized = faceapi.resizeResults(detections, displaySize);

            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            resized.forEach(detection => {
                // Draw face box
                const box = detection.detection.box;
                ctx.strokeStyle = '#6366f1';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.roundRect(box.x, box.y, box.width, box.height, 8);
                ctx.stroke();

                // Try to match face
                if (faceMatcher) {
                    const match = faceMatcher.findBestMatch(detection.descriptor);
                    const label = match.toString();
                    const nim = match.label;
                    const distance = match.distance;
                    const confidence = 1 - distance;

                    // Draw label
                    ctx.fillStyle = confidence > 0.5 ? 'rgba(34,197,94,0.8)' : 'rgba(239,68,68,0.8)';
                    ctx.fillRect(box.x, box.y - 28, box.width, 28);
                    ctx.fillStyle = '#fff';
                    ctx.font = '13px Inter, sans-serif';
                    ctx.fillText(
                        nim !== 'unknown' ? `${nim} (${(confidence * 100).toFixed(0)}%)` : 'Tidak Dikenali',
                        box.x + 6, box.y - 8
                    );
                }
            });
        }, 200);
    }

    // ===================== VERIFY FACE =====================
    async function verifyFace() {
        if (!cameraActive || !isModelLoaded) {
            showNotification('Nyalakan kamera terlebih dahulu', 'error');
            return;
        }

        const video = document.getElementById('videoElement');
        showNotification('Memverifikasi wajah...', 'info');

        try {
            const detection = await faceapi
                .detectSingleFace(video, new faceapi.SsdMobilenetv1Options({ minConfidence: 0.5 }))
                .withFaceLandmarks()
                .withFaceDescriptor();

            if (!detection) {
                showNotification('Tidak ada wajah terdeteksi. Arahkan wajah ke kamera.', 'error');
                showAccessDenied('Tidak ada wajah terdeteksi');
                return;
            }

            // Animate
            const anim = document.getElementById('faceDetectedAnim');
            anim.classList.remove('active');
            void anim.offsetWidth;
            anim.classList.add('active');

            const descriptor = Array.from(detection.descriptor);

            if (!faceMatcher) {
                // No face data to compare, redirect to register
                showAccessDenied('Belum ada data wajah. Silakan registrasi.');
                sendVerifyRequest(null, 0, JSON.stringify(descriptor));
                return;
            }

            const match = faceMatcher.findBestMatch(detection.descriptor);
            const nim = match.label;
            const confidence = 1 - match.distance;

            if (nim === 'unknown' || confidence < 0.5) {
                showAccessDenied('Wajah tidak dikenali. Confidence: ' + (confidence * 100).toFixed(1) + '%');
                sendVerifyRequest(null, confidence, JSON.stringify(descriptor));
            } else {
                // Get snapshot
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                const imageData = canvas.toDataURL('image/jpeg', 0.8);

                sendVerifyRequest(nim, confidence, JSON.stringify(descriptor), imageData);
            }
        } catch (err) {
            console.error('Verify error:', err);
            showNotification('Error saat verifikasi: ' + err.message, 'error');
        }
    }

    async function sendVerifyRequest(nim, confidence, faceDescriptor, imageData) {
        try {
            const res = await fetch(API_BASE + '/verify', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    ...(jwtToken ? { 'Authorization': 'Bearer ' + jwtToken } : {})
                },
                body: JSON.stringify({ nim, confidence, faceDescriptor, imageData })
            });
            const data = await res.json();

            if (data.success && data.recognized) {
                // Access GRANTED
                jwtToken = data.token;
                localStorage.setItem('monitor_token', jwtToken);
                currentUser = data.user;
                showProfileCard(data.user, confidence, 'GRANTED');
                showAccessGranted(data.message);
                showUserBadge(data.user);
                showNotification(' ' + data.message, 'success');

                if (data.user.isAdmin || data.user.role === 'ADMIN') {
                    loadAdminPanel();
                }

                // Refresh stats & logs
                loadStats();
                refreshLogs();
            } else if (data.redirect) {
                showNotification('Wajah tidak dikenali. Silakan registrasi.', 'error');
                // Don't redirect automatically, let user decide
            } else {
                showAccessDenied(data.message);
                showNotification(data.message, 'error');
                loadStats();
                refreshLogs();
            }
        } catch (err) {
            console.error('Verify API error:', err);
            showNotification('Gagal menghubungi server', 'error');
        }
    }

    // ===================== PROFILE DISPLAY =====================
    function showProfileCard(user, confidence, status) {
        document.getElementById('profilePlaceholder').style.display = 'none';
        const card = document.getElementById('profileCard');
        card.classList.add('show');

        document.getElementById('profileName').textContent = user.nama;
        document.getElementById('profileNim').textContent = 'NIM: ' + user.nim;
        document.getElementById('profileConfidence').textContent = (confidence * 100).toFixed(1) + '%';
        document.getElementById('profileStatus').textContent = user.isActive ? 'Aktif' : 'Nonaktif';
        document.getElementById('profileStatus').style.color = user.isActive ? 'var(--success)' : 'var(--danger)';
        document.getElementById('profileTime').textContent = new Date().toLocaleTimeString('id-ID');
        document.getElementById('profileFaceCount').textContent = user.faceCount || '0';

        const badge = document.getElementById('profileBadge');
        if (user.role === 'ADMIN' || user.isAdmin) {
            badge.className = 'profile-badge badge-admin';
            badge.textContent = 'ADMIN';
        } else {
            badge.className = 'profile-badge badge-user';
            badge.textContent = 'USER';
        }

        // Profile photo
        const photoEl = document.getElementById('profilePhoto');
        if (user.photoUrl && user.photoUrl.startsWith('data:')) {
            photoEl.innerHTML = `<img src="${user.photoUrl}" alt="foto">`;
        } else {
            photoEl.textContent = user.nama ? user.nama.charAt(0).toUpperCase() : '?';
        }
    }

    function showAccessGranted(message) {
        document.getElementById('accessGranted').classList.add('show');
        document.getElementById('accessDenied').classList.remove('show');
        document.getElementById('grantedMessage').textContent = message || 'Verifikasi wajah berhasil';
    }

    function showAccessDenied(message) {
        document.getElementById('profilePlaceholder').style.display = 'none';
        const card = document.getElementById('profileCard');
        card.classList.add('show');
        document.getElementById('profileName').textContent = 'Tidak Dikenali';
        document.getElementById('profileNim').textContent = '-';
        document.getElementById('profilePhoto').textContent = '?';

        document.getElementById('accessDenied').classList.add('show');
        document.getElementById('accessGranted').classList.remove('show');
        document.getElementById('deniedMessage').textContent = message || 'Verifikasi gagal';
    }

    function showUserBadge(user) {
        const badge = document.getElementById('userBadge');
        badge.style.display = '';
        document.getElementById('userAvatarSmall').textContent = user.nama ? user.nama.charAt(0).toUpperCase() : '?';
        document.getElementById('userNameSmall').textContent = user.nama;
        document.getElementById('userRoleSmall').textContent = user.role;
    }

    // ===================== STATS =====================
    async function loadStats() {
        try {
            const res = await fetch(API_BASE + '/stats');
            const data = await res.json();
            if (data.success) {
                document.getElementById('statUsers').textContent = data.totalUsers || 0;
                document.getElementById('statAdmins').textContent = data.totalAdmins || 0;
                document.getElementById('statGranted').textContent = data.grantedToday || 0;
                document.getElementById('statDenied').textContent = data.deniedToday || 0;
                document.getElementById('statTotal').textContent = data.totalToday || 0;
            }
        } catch (err) {
            console.error('Stats error:', err);
        }
    }

    // ===================== LOGS =====================
    async function refreshLogs() {
        try {
            const res = await fetch(API_BASE + '/logs?limit=30');
            const data = await res.json();
            const tbody = document.getElementById('logTableBody');

            if (!data.success || !data.logs || data.logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:var(--text-muted);">Belum ada log aktivitas</td></tr>';
                return;
            }

            tbody.innerHTML = data.logs.map(log => `
                <tr>
                    <td>
                        <div style="font-size:12px;">${log.tanggal || '-'}</div>
                        <div style="font-size:11px; color:var(--text-muted);">${log.jam || '-'}</div>
                    </td>
                    <td>${log.nama || '-'}</td>
                    <td style="color:var(--text-secondary);">${log.nim || '-'}</td>
                    <td>
                        <span class="status-badge ${log.status === 'GRANTED' ? 'status-granted' : 'status-denied'}">
                            ${log.status}
                        </span>
                    </td>
                    <td style="color:${log.confidence >= 0.7 ? 'var(--success)' : log.confidence >= 0.5 ? 'var(--warning)' : 'var(--danger)'}; font-weight:600;">
                        ${(log.confidence * 100).toFixed(1)}%
                    </td>
                </tr>
            `).join('');
        } catch (err) {
            console.error('Logs error:', err);
        }
    }

    // ===================== CHART =====================
    let accessChart = null;
    async function loadChart() {
        try {
            const res = await fetch(API_BASE + '/stats/daily');
            const data = await res.json();

            const labels = [];
            const grantedData = [];
            const deniedData = [];

            if (data.data && data.data.length > 0) {
                data.data.forEach(d => {
                    labels.push(d.date);
                    grantedData.push(d.granted);
                    deniedData.push(d.denied);
                });
            } else {
                // Default with today
                const today = new Date().toISOString().split('T')[0];
                labels.push(today);
                grantedData.push(0);
                deniedData.push(0);
            }

            const ctx = document.getElementById('accessChart').getContext('2d');

            if (accessChart) accessChart.destroy();

            accessChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Granted',
                            data: grantedData,
                            backgroundColor: 'rgba(34, 197, 94, 0.5)',
                            borderColor: 'rgba(34, 197, 94, 1)',
                            borderWidth: 1,
                            borderRadius: 6
                        },
                        {
                            label: 'Denied',
                            data: deniedData,
                            backgroundColor: 'rgba(239, 68, 68, 0.5)',
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 1,
                            borderRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: 'rgba(255,255,255,0.6)', font: { family: 'Inter', size: 12 } }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: 'rgba(255,255,255,0.4)', font: { size: 11 } },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: { color: 'rgba(255,255,255,0.4)', stepSize: 1, font: { size: 11 } },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        }
                    }
                }
            });
        } catch (err) {
            console.error('Chart error:', err);
        }
    }

    // ===================== ADMIN PANEL =====================
    async function loadAdminPanel() {
        const panel = document.getElementById('adminPanel');
        panel.classList.add('show');

        try {
            const res = await fetch(API_BASE + '/users', {
                headers: jwtToken ? { 'Authorization': 'Bearer ' + jwtToken } : {}
            });
            const data = await res.json();

            if (!data.success || !data.users) return;

            const container = document.getElementById('adminUserList');
            container.innerHTML = data.users.map(u => `
                <div class="user-card">
                    <div class="avatar ${u.role === 'ADMIN' ? 'admin-avatar' : 'user-avatar'}">
                        ${u.nama ? u.nama.charAt(0).toUpperCase() : '?'}
                    </div>
                    <div class="user-details">
                        <div class="user-name">${u.nama}</div>
                        <div class="user-nim">NIM: ${u.nim} | Foto: ${u.faceCount || 0}</div>
                    </div>
                    <div class="actions">
                        <select class="role-select" onchange="changeRole('${u.nim}', this.value)">
                            <option value="USER" ${u.role === 'USER' ? 'selected' : ''}>USER</option>
                            <option value="ADMIN" ${u.role === 'ADMIN' ? 'selected' : ''}>ADMIN</option>
                        </select>
                    </div>
                </div>
            `).join('');
        } catch (err) {
            console.error('Admin panel error:', err);
        }
    }

    async function changeRole(nim, newRole) {
        try {
            const res = await fetch(API_BASE + '/users/' + nim + '/role', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + jwtToken
                },
                body: JSON.stringify({ role: newRole })
            });
            const data = await res.json();

            if (data.success) {
                showNotification(data.message, 'success');
                loadStats();
            } else {
                showNotification(data.message, 'error');
            }
        } catch (err) {
            showNotification('Gagal mengubah role', 'error');
        }
    }

    // ===================== REGISTER MODAL =====================
    function openRegisterModal() {
        document.getElementById('registerModal').classList.add('show');
    }

    function closeRegisterModal() {
        document.getElementById('registerModal').classList.remove('show');
    }

    async function registerFromModal() {
        const nim = document.getElementById('regNim').value.trim();
        const nama = document.getElementById('regNama').value.trim();
        const role = document.getElementById('regRole').value;

        if (!nim || !nama) {
            showNotification('NIM dan Nama wajib diisi', 'error');
            return;
        }

        try {
            const res = await fetch(API_BASE + '/auth/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nim, nama, role })
            });
            const data = await res.json();

            if (data.success) {
                showNotification(data.message, 'success');
                closeRegisterModal();
                loadStats();
                loadAdminPanel();
                // Clear form
                document.getElementById('regNim').value = '';
                document.getElementById('regNama').value = '';
            } else {
                showNotification(data.message, 'error');
            }
        } catch (err) {
            showNotification('Gagal registrasi: ' + err.message, 'error');
        }
    }

    // ===================== SNAPSHOT =====================
    function captureSnapshot() {
        if (!cameraActive) {
            showNotification('Kamera tidak aktif', 'error');
            return;
        }
        const video = document.getElementById('videoElement');
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        const link = document.createElement('a');
        link.download = 'snapshot_' + Date.now() + '.jpg';
        link.href = canvas.toDataURL('image/jpeg', 0.9);
        link.click();
        showNotification('Snapshot tersimpan!', 'success');
    }

    // ===================== NOTIFICATIONS =====================
    function showNotification(message, type = 'info') {
        // Remove existing
        document.querySelectorAll('.notification-toast').forEach(n => n.remove());

        const toast = document.createElement('div');
        toast.className = `notification-toast ${type}`;

        const icons = { success: '&#9989;', error: '&#10060;', info: '&#8505;&#65039;' };
        toast.innerHTML = `
            <span style="font-size:20px;">${icons[type] || icons.info}</span>
            <span style="font-size:13px; font-weight:500;">${message}</span>
        `;

        toast.onclick = () => toast.remove();
        document.body.appendChild(toast);

        setTimeout(() => {
            if (toast.parentNode) toast.remove();
        }, 4000);
    }

    // ===================== LOGOUT =====================
    function logout() {
        localStorage.removeItem('monitor_token');
        jwtToken = null;
        currentUser = null;
        document.getElementById('userBadge').style.display = 'none';
        document.getElementById('adminPanel').classList.remove('show');
        document.getElementById('profileCard').classList.remove('show');
        document.getElementById('profilePlaceholder').style.display = '';
        document.getElementById('accessGranted').classList.remove('show');
        document.getElementById('accessDenied').classList.remove('show');
        showNotification('Berhasil logout', 'info');
    }

    // Auto-refresh stats & logs setiap 30 detik
    setInterval(() => {
        loadStats();
        refreshLogs();
    }, 30000);

    // Refresh chart setiap 60 detik
    setInterval(loadChart, 60000);
</script>
</body>
</html>
