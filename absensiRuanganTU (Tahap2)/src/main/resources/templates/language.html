<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Language Learning - AbsensiKampus</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background-color: #f8f8f8; color: #1a1a1a; min-height: 100vh; }
        .sidebar { position: fixed; left: 0; top: 0; width: 260px; height: 100vh; background: #0a0a0a; color: #fff; z-index: 100; display: flex; flex-direction: column; }
        .sidebar-header { padding: 28px 24px; border-bottom: 1px solid rgba(255,255,255,0.08); }
        .sidebar-header .logo { display: flex; align-items: center; gap: 12px; }
        .sidebar-header .logo-icon { width: 40px; height: 40px; background: #fff; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .sidebar-header .logo-text { font-size: 16px; font-weight: 700; }
        .sidebar-header .logo-sub { font-size: 11px; color: rgba(255,255,255,0.5); margin-top: 2px; }
        .sidebar-nav { padding: 16px 12px; flex: 1; overflow-y: auto; }
        .nav-label { font-size: 10px; text-transform: uppercase; letter-spacing: 1.5px; color: rgba(255,255,255,0.35); padding: 8px 12px; margin-top: 8px; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 11px 14px; border-radius: 8px; color: rgba(255,255,255,0.6); text-decoration: none; font-size: 14px; font-weight: 500; transition: all 0.2s; cursor: pointer; margin-bottom: 2px; }
        .nav-item:hover { background: rgba(255,255,255,0.08); color: #fff; }
        .nav-item.active { background: #fff; color: #0a0a0a; }
        .nav-item .nav-icon { width: 20px; text-align: center; font-size: 16px; }
        .sidebar-footer { padding: 20px 24px; border-top: 1px solid rgba(255,255,255,0.08); }
        .sidebar-footer .version { font-size: 11px; color: rgba(255,255,255,0.3); }
        .main-content { margin-left: 260px; min-height: 100vh; }
        .topbar { background: #fff; border-bottom: 1px solid #e5e5e5; padding: 0 36px; height: 64px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 50; }
        .topbar h1 { font-size: 20px; font-weight: 700; }
        .page-content { padding: 28px 36px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 28px; }
        .stat-card { background: #fff; border-radius: 12px; padding: 24px; border: 1px solid #e5e5e5; }
        .stat-card .stat-label { font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
        .stat-card .stat-value { font-size: 28px; font-weight: 800; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .section-header h2 { font-size: 18px; font-weight: 700; }
        .btn { padding: 10px 20px; border-radius: 8px; border: none; font-size: 13px; font-weight: 600; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.2s; }
        .btn-primary { background: #0a0a0a; color: #fff; }
        .btn-primary:hover { background: #333; }
        .btn-secondary { background: #f0f0f0; color: #333; border: 1px solid #ddd; }
        .btn-danger { background: #ef4444; color: #fff; }
        .btn-success { background: #22c55e; color: #fff; }
        .btn-success:hover { background: #16a34a; }
        .btn-quiz { background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; }
        .btn-quiz:hover { opacity: 0.9; }
        .btn-sm { padding: 6px 14px; font-size: 12px; }

        /* Course cards */
        .course-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; margin-bottom: 32px; }
        .course-card { background: #fff; border-radius: 14px; border: 1px solid #e5e5e5; padding: 24px; transition: all 0.3s; cursor: pointer; position: relative; overflow: hidden; }
        .course-card:hover { transform: translateY(-4px); box-shadow: 0 12px 30px rgba(0,0,0,0.08); }
        .course-card .course-emoji { font-size: 48px; margin-bottom: 14px; }
        .course-card .course-lang { font-size: 18px; font-weight: 800; margin-bottom: 4px; }
        .course-card .course-level { font-size: 12px; padding: 4px 12px; border-radius: 20px; background: #f0f0f0; display: inline-block; margin-bottom: 8px; }
        .course-card .course-level.beginner { background: #dcfce7; color: #16a34a; }
        .course-card .course-level.intermediate { background: #dbeafe; color: #2563eb; }
        .course-card .course-level.advanced { background: #fef3c7; color: #d97706; }
        .course-card .course-desc { font-size: 13px; color: #666; line-height: 1.5; margin-bottom: 12px; }
        .course-card .course-stats { display: flex; gap: 16px; font-size: 12px; color: #888; }
        .course-actions { display: flex; gap: 8px; margin-top: 12px; }

        /* Vocab panel */
        .vocab-panel { background: #fff; border-radius: 12px; border: 1px solid #e5e5e5; padding: 24px; margin-bottom: 28px; display: none; }
        .vocab-panel.show { display: block; }
        .vocab-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid #f0f0f0; }
        .vocab-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 14px; }
        .vocab-card { background: #fafafa; border-radius: 10px; padding: 16px; border: 1px solid #eee; position: relative; transition: all 0.2s; }
        .vocab-card:hover { background: #fff; border-color: #ddd; }
        .vocab-card.learned { border-left: 4px solid #22c55e; }
        .vocab-word { font-size: 20px; font-weight: 800; color: #0a0a0a; margin-bottom: 4px; }
        .vocab-pronunciation { font-size: 12px; color: #888; font-style: italic; margin-bottom: 6px; }
        .vocab-translation { font-size: 14px; color: #333; font-weight: 600; margin-bottom: 6px; }
        .vocab-example { font-size: 12px; color: #999; margin-bottom: 8px; line-height: 1.4; }
        .vocab-category { font-size: 11px; background: #f0f0f0; padding: 3px 10px; border-radius: 12px; color: #555; display: inline-block; }
        .vocab-check { position: absolute; top: 12px; right: 12px; width: 24px; height: 24px; border-radius: 50%; border: 2px solid #ddd; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; transition: 0.2s; }
        .vocab-check.checked { background: #22c55e; border-color: #22c55e; color: #fff; }

        /* Quiz section */
        .quiz-container { background: #fff; border-radius: 16px; border: 1px solid #e5e5e5; padding: 32px; margin-bottom: 28px; display: none; }
        .quiz-container.show { display: block; }
        .quiz-progress { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; }
        .quiz-progress-bar { flex: 1; height: 6px; background: #f0f0f0; border-radius: 3px; }
        .quiz-progress-fill { height: 100%; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 3px; transition: width 0.4s; }
        .quiz-progress-text { font-size: 13px; font-weight: 600; color: #888; }
        .quiz-question { font-size: 14px; color: #888; margin-bottom: 8px; }
        .quiz-word { font-size: 36px; font-weight: 900; margin-bottom: 6px; text-align: center; padding: 20px; }
        .quiz-pronunciation { font-size: 14px; color: #888; text-align: center; margin-bottom: 24px; font-style: italic; }
        .quiz-options { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; max-width: 500px; margin: 0 auto; }
        .quiz-option { padding: 16px 20px; border: 2px solid #e5e5e5; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; text-align: center; transition: all 0.3s; background: #fff; font-family: 'Inter', sans-serif; }
        .quiz-option:hover { border-color: #0a0a0a; background: #fafafa; }
        .quiz-option.correct { border-color: #22c55e; background: #dcfce7; color: #16a34a; }
        .quiz-option.wrong { border-color: #ef4444; background: #fee2e2; color: #dc2626; }
        .quiz-result { text-align: center; padding: 40px; }
        .quiz-score { font-size: 64px; font-weight: 900; margin-bottom: 8px; }
        .quiz-score.excellent { color: #16a34a; }
        .quiz-score.good { color: #2563eb; }
        .quiz-score.poor { color: #ef4444; }
        .quiz-message { font-size: 16px; color: #666; margin-bottom: 24px; }

        /* History table */
        .data-table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 12px; overflow: hidden; border: 1px solid #e5e5e5; margin-bottom: 28px; }
        .data-table th { background: #fafafa; padding: 14px 16px; text-align: left; font-size: 12px; font-weight: 600; color: #555; text-transform: uppercase; border-bottom: 1px solid #e5e5e5; }
        .data-table td { padding: 14px 16px; font-size: 14px; border-bottom: 1px solid #f0f0f0; }

        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-overlay.show { display: flex; }
        .modal { background: #fff; border-radius: 16px; padding: 32px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        .modal h3 { font-size: 18px; font-weight: 700; margin-bottom: 20px; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-size: 13px; font-weight: 600; color: #333; margin-bottom: 6px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 14px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; font-family: 'Inter', sans-serif; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #0a0a0a; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }

        .tab-buttons { display: flex; gap: 8px; margin-bottom: 20px; }
        .tab-btn { padding: 8px 20px; border-radius: 8px; border: 1px solid #e5e5e5; background: #fff; font-size: 13px; font-weight: 600; cursor: pointer; transition: 0.2s; font-family: 'Inter', sans-serif; }
        .tab-btn.active { background: #0a0a0a; color: #fff; border-color: #0a0a0a; }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <div class="logo-icon">&#127979;</div>
                <div>
                    <div class="logo-text">AbsensiKampus</div>
                    <div class="logo-sub">Monitoring System</div>
                </div>
            </div>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-label">Menu Utama</div>
            <a class="nav-item" href="/"><span class="nav-icon">&#9632;</span><span>Dashboard</span></a>
            <div class="nav-label" style="margin-top:24px;">Fitur Lainnya</div>
            <a class="nav-item" href="/property"><span class="nav-icon">&#127968;</span><span>Real Estate</span></a>
            <a class="nav-item" href="/project"><span class="nav-icon">&#128203;</span><span>Project Management</span></a>
            <a class="nav-item" href="/chatbot"><span class="nav-icon">&#129302;</span><span>Chatbot</span></a>
            <a class="nav-item" href="/music"><span class="nav-icon">&#127925;</span><span>Music Streaming</span></a>
            <a class="nav-item" href="/expense"><span class="nav-icon">&#128176;</span><span>Expense Report</span></a>
            <a class="nav-item active" href="/language"><span class="nav-icon">&#127760;</span><span>Language Learning</span></a>
        </nav>
        <div class="sidebar-footer"><div class="version">Absensi Ruangan TU v2.0</div></div>
    </aside>

    <div class="main-content">
        <div class="topbar">
            <h1>&#127760; Language Learning</h1>
            <div>
                <button class="btn btn-quiz" onclick="showQuizSelect()">&#127919; Mulai Quiz</button>
            </div>
        </div>

        <div class="page-content">
            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Kursus Bahasa</div>
                    <div class="stat-value" th:text="${totalCourses}">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Kosakata</div>
                    <div class="stat-value" th:text="${totalVocab}">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Sudah Dipelajari</div>
                    <div class="stat-value" th:text="${totalLearned}">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Progress</div>
                    <div class="stat-value" th:text="${totalVocab > 0 ? (totalLearned * 100 / totalVocab) + '%' : '0%'}">0%</div>
                </div>
            </div>

            <!-- Courses -->
            <div class="section-header">
                <h2>&#128218; Pilih Bahasa</h2>
                <button class="btn btn-primary" onclick="showAddCourse()">+ Tambah Kursus</button>
            </div>
            <div class="course-grid" id="courseGrid">
                <div class="course-card" th:each="c : ${courses}" th:data-id="${c.idCourse}" onclick="viewCourse(parseInt(this.dataset.id))">
                    <div class="course-emoji" th:text="${c.iconEmoji}">&#127468;</div>
                    <div class="course-lang" th:text="${c.bahasa}">English</div>
                    <span class="course-level" th:classappend="${c.level == 'Beginner' ? 'beginner' : c.level == 'Intermediate' ? 'intermediate' : 'advanced'}" th:text="${c.level}">Beginner</span>
                    <div class="course-desc" th:text="${c.deskripsi}">Deskripsi kursus</div>
                    <div class="course-stats">
                        <span>&#128214; <span th:text="${c.totalVocab}">0</span> kosakata</span>
                    </div>
                    <div class="course-actions" onclick="event.stopPropagation()">
                        <button class="btn btn-secondary btn-sm" th:data-id="${c.idCourse}" onclick="editCourse(parseInt(this.dataset.id))">Edit</button>
                        <button class="btn btn-danger btn-sm" th:data-id="${c.idCourse}" onclick="deleteCourse(parseInt(this.dataset.id))">Hapus</button>
                        <button class="btn btn-quiz btn-sm" th:data-id="${c.idCourse}" onclick="startQuiz(parseInt(this.dataset.id))">Quiz</button>
                    </div>
                </div>
            </div>

            <!-- Vocabulary Panel -->
            <div class="vocab-panel" id="vocabPanel">
                <div class="vocab-header">
                    <h3 id="vocabTitle">Kosakata</h3>
                    <div>
                        <button class="btn btn-primary btn-sm" onclick="showAddVocab()">+ Tambah Kata</button>
                        <button class="btn btn-secondary btn-sm" onclick="closeVocab()">Tutup</button>
                    </div>
                </div>
                <div class="vocab-grid" id="vocabGrid"></div>
            </div>

            <!-- Quiz Container -->
            <div class="quiz-container" id="quizContainer">
                <div id="quizContent"></div>
            </div>

            <!-- Quiz History -->
            <div class="section-header" th:if="${!quizHistory.isEmpty()}">
                <h2>&#128200; Riwayat Quiz</h2>
            </div>
            <table class="data-table" th:if="${!quizHistory.isEmpty()}">
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Bahasa</th>
                        <th>Total Soal</th>
                        <th>Benar</th>
                        <th>Skor</th>
                        <th>Tanggal</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="q, idx : ${quizHistory}">
                        <td th:text="${idx.index + 1}">1</td>
                        <td th:text="${q.bahasaCourse}">English</td>
                        <td th:text="${q.totalQuestions}">10</td>
                        <td th:text="${q.correctAnswers}">8</td>
                        <td style="font-weight:700"
                            th:style="${q.score >= 80 ? 'color:#16a34a;font-weight:700' : q.score >= 60 ? 'color:#2563eb;font-weight:700' : 'color:#ef4444;font-weight:700'}"
                            th:text="${q.score + '%'}">80%</td>
                        <td th:text="${#dates.format(q.takenAt, 'dd/MM/yyyy HH:mm')}">-</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Course Modal -->
    <div class="modal-overlay" id="courseModal">
        <div class="modal">
            <h3 id="courseModalTitle">Tambah Kursus Bahasa</h3>
            <input type="hidden" id="editCourseId">
            <div class="form-row">
                <div class="form-group">
                    <label>Bahasa *</label>
                    <select id="courseBahasa">
                        <option value="English">English / Inggris</option>
                        <option value="Japanese">Japanese / Jepang</option>
                        <option value="Korean">Korean / Korea</option>
                        <option value="Mandarin">Mandarin / Cina</option>
                        <option value="Arabic">Arabic / Arab</option>
                        <option value="French">French / Prancis</option>
                        <option value="German">German / Jerman</option>
                        <option value="Spanish">Spanish / Spanyol</option>
                        <option value="Thai">Thai / Thailand</option>
                        <option value="Hindi">Hindi / India</option>
                        <option value="Portuguese">Portuguese / Portugis</option>
                        <option value="Italian">Italian / Italia</option>
                        <option value="Russian">Russian / Rusia</option>
                        <option value="Dutch">Dutch / Belanda</option>
                        <option value="Turkish">Turkish / Turki</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Level *</label>
                    <select id="courseLevel">
                        <option value="Beginner">Beginner / Pemula</option>
                        <option value="Intermediate">Intermediate / Menengah</option>
                        <option value="Advanced">Advanced / Lanjutan</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Icon Emoji</label>
                <input type="text" id="courseIcon" placeholder="&#127468;&#127463;" maxlength="10">
                <div style="font-size:11px;color:#888;margin-top:4px;">Contoh: &#127468;&#127463; &#127471;&#127477; &#127472;&#127479; &#127464;&#127475; &#127462;&#127466;</div>
            </div>
            <div class="form-group">
                <label>Deskripsi</label>
                <textarea id="courseDesc" rows="3" placeholder="Deskripsi kursus bahasa"></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('courseModal')">Batal</button>
                <button class="btn btn-primary" onclick="saveCourse()">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Vocab Modal -->
    <div class="modal-overlay" id="vocabModal">
        <div class="modal">
            <h3 id="vocabModalTitle">Tambah Kosakata</h3>
            <input type="hidden" id="editVocabId">
            <input type="hidden" id="currentCourseId">
            <div class="form-group">
                <label>Kata / Phrase *</label>
                <input type="text" id="vocabKata" placeholder="Hello">
            </div>
            <div class="form-group">
                <label>Terjemahan (Indonesia) *</label>
                <input type="text" id="vocabTerjemahan" placeholder="Halo">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Pelafalan</label>
                    <input type="text" id="vocabPelafalan" placeholder="helo">
                </div>
                <div class="form-group">
                    <label>Kategori</label>
                    <select id="vocabKategori">
                        <option value="Greeting">Greeting / Sapaan</option>
                        <option value="Noun">Noun / Kata Benda</option>
                        <option value="Verb">Verb / Kata Kerja</option>
                        <option value="Adjective">Adjective / Kata Sifat</option>
                        <option value="Adverb">Adverb / Kata Keterangan</option>
                        <option value="Phrase">Phrase / Frasa</option>
                        <option value="Number">Number / Angka</option>
                        <option value="Question">Question / Pertanyaan</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Contoh Kalimat</label>
                <textarea id="vocabContoh" rows="2" placeholder="Hello, how are you?"></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('vocabModal')">Batal</button>
                <button class="btn btn-primary" onclick="saveVocab()">Simpan</button>
            </div>
        </div>
    </div>

    <script>
        let currentCourseId = null;
        let quizData = [];
        let quizIndex = 0;
        let quizCorrect = 0;

        // ===== COURSES =====
        function showAddCourse() {
            document.getElementById('courseModalTitle').textContent = 'Tambah Kursus Bahasa';
            document.getElementById('editCourseId').value = '';
            document.getElementById('courseBahasa').value = 'English';
            document.getElementById('courseLevel').value = 'Beginner';
            document.getElementById('courseIcon').value = '';
            document.getElementById('courseDesc').value = '';
            document.getElementById('courseModal').classList.add('show');
        }

        function editCourse(id) {
            fetch('/language/api/courses/' + id).then(r => r.json()).then(c => {
                document.getElementById('courseModalTitle').textContent = 'Edit Kursus';
                document.getElementById('editCourseId').value = c.idCourse;
                document.getElementById('courseBahasa').value = c.bahasa;
                document.getElementById('courseLevel').value = c.level;
                document.getElementById('courseIcon').value = c.iconEmoji || '';
                document.getElementById('courseDesc').value = c.deskripsi || '';
                document.getElementById('courseModal').classList.add('show');
            });
        }

        function saveCourse() {
            const id = document.getElementById('editCourseId').value;
            const data = {
                bahasa: document.getElementById('courseBahasa').value,
                level: document.getElementById('courseLevel').value,
                iconEmoji: document.getElementById('courseIcon').value,
                deskripsi: document.getElementById('courseDesc').value
            };
            if (id) data.idCourse = parseInt(id);
            const url = id ? '/language/api/courses/update' : '/language/api/courses/add';
            fetch(url, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data) })
                .then(r => r.json())
                .then(res => { if (res.success) location.reload(); else alert(res.message); });
        }

        function deleteCourse(id) {
            if (!confirm('Hapus kursus ini beserta semua kosakata dan riwayat quiz?')) return;
            fetch('/language/api/courses/delete', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({idCourse: id}) })
                .then(r => r.json())
                .then(res => { if (res.success) location.reload(); else alert(res.message); });
        }

        // ===== VOCABULARY =====
        function viewCourse(id) {
            currentCourseId = id;
            document.getElementById('currentCourseId').value = id;
            document.getElementById('vocabPanel').classList.add('show');
            
            fetch('/language/api/courses/' + id).then(r => r.json()).then(c => {
                document.getElementById('vocabTitle').textContent = c.iconEmoji + ' Kosakata ' + c.bahasa + ' - ' + c.level;
            });
            loadVocab(id);
        }

        function loadVocab(courseId) {
            fetch('/language/api/vocab/' + courseId).then(r => r.json()).then(vocabs => {
                const grid = document.getElementById('vocabGrid');
                grid.innerHTML = vocabs.map(v => `
                    <div class="vocab-card ${v.learned ? 'learned' : ''}" id="vocab-${v.idVocab}">
                        <div class="vocab-check ${v.learned ? 'checked' : ''}" onclick="toggleLearned(${v.idVocab}, ${!v.learned})">
                            ${v.learned ? '&#10003;' : ''}
                        </div>
                        <div class="vocab-word">${v.kata}</div>
                        ${v.pelafalan ? '<div class="vocab-pronunciation">' + v.pelafalan + '</div>' : ''}
                        <div class="vocab-translation">${v.terjemahan}</div>
                        ${v.contohKalimat ? '<div class="vocab-example">"' + v.contohKalimat + '"</div>' : ''}
                        <div style="display:flex;justify-content:space-between;align-items:center">
                            <span class="vocab-category">${v.kategoriKata || ''}</span>
                            <button class="btn btn-danger btn-sm" onclick="deleteVocab(${v.idVocab})" style="font-size:11px;padding:4px 10px;">Hapus</button>
                        </div>
                    </div>`).join('');
                if (vocabs.length === 0) grid.innerHTML = '<div style="color:#888;padding:20px;">Belum ada kosakata. Klik "+ Tambah Kata" untuk memulai.</div>';
            });
        }

        function closeVocab() {
            document.getElementById('vocabPanel').classList.remove('show');
            currentCourseId = null;
        }

        function showAddVocab() {
            if (!currentCourseId) return;
            document.getElementById('vocabModalTitle').textContent = 'Tambah Kosakata';
            document.getElementById('editVocabId').value = '';
            document.getElementById('vocabKata').value = '';
            document.getElementById('vocabTerjemahan').value = '';
            document.getElementById('vocabPelafalan').value = '';
            document.getElementById('vocabKategori').value = 'Noun';
            document.getElementById('vocabContoh').value = '';
            document.getElementById('vocabModal').classList.add('show');
        }

        function saveVocab() {
            const id = document.getElementById('editVocabId').value;
            const data = {
                idCourse: currentCourseId,
                kata: document.getElementById('vocabKata').value,
                terjemahan: document.getElementById('vocabTerjemahan').value,
                pelafalan: document.getElementById('vocabPelafalan').value,
                kategoriKata: document.getElementById('vocabKategori').value,
                contohKalimat: document.getElementById('vocabContoh').value
            };
            if (!data.kata || !data.terjemahan) { alert('Kata dan terjemahan wajib diisi!'); return; }
            if (id) data.idVocab = parseInt(id);
            const url = id ? '/language/api/vocab/update' : '/language/api/vocab/add';
            fetch(url, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data) })
                .then(r => r.json())
                .then(res => {
                    if (res.success) { closeModal('vocabModal'); loadVocab(currentCourseId); setTimeout(() => location.reload(), 300); }
                    else alert(res.message);
                });
        }

        function deleteVocab(id) {
            if (!confirm('Hapus kosakata ini?')) return;
            fetch('/language/api/vocab/delete', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({idVocab: id}) })
                .then(r => r.json())
                .then(res => { if (res.success) { loadVocab(currentCourseId); setTimeout(() => location.reload(), 300); } else alert(res.message); });
        }

        function toggleLearned(id, learned) {
            fetch('/language/api/vocab/mark-learned', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({idVocab: id, learned: learned}) })
                .then(r => r.json())
                .then(res => { if (res.success) loadVocab(currentCourseId); });
        }

        // ===== QUIZ =====
        function showQuizSelect() {
            alert('Pilih kursus bahasa terlebih dahulu, lalu klik tombol "Quiz" pada kartu kursus.');
        }

        function startQuiz(courseId) {
            currentCourseId = courseId;
            fetch('/language/api/quiz/' + courseId + '?count=10')
                .then(r => r.json())
                .then(data => {
                    if (data.length < 4) { alert('Minimal 4 kosakata diperlukan untuk memulai quiz!'); return; }
                    quizData = data;
                    quizIndex = 0;
                    quizCorrect = 0;
                    document.getElementById('quizContainer').classList.add('show');
                    renderQuizQuestion();
                    document.getElementById('quizContainer').scrollIntoView({behavior:'smooth'});
                });
        }

        function renderQuizQuestion() {
            if (quizIndex >= quizData.length) { showQuizResult(); return; }
            const q = quizData[quizIndex];
            const content = document.getElementById('quizContent');
            content.innerHTML = `
                <div class="quiz-progress">
                    <div class="quiz-progress-bar"><div class="quiz-progress-fill" style="width:${(quizIndex/quizData.length)*100}%"></div></div>
                    <div class="quiz-progress-text">${quizIndex+1} / ${quizData.length}</div>
                </div>
                <div class="quiz-question">Apa arti kata berikut dalam Bahasa Indonesia?</div>
                <div class="quiz-word">${q.kata}</div>
                ${q.pelafalan ? '<div class="quiz-pronunciation">' + q.pelafalan + '</div>' : ''}
                <div class="quiz-options">
                    ${q.options.map((opt, i) => `<button class="quiz-option" onclick="answerQuiz(this, '${opt.replace(/'/g,"\\'")}', '${q.correctAnswer.replace(/'/g,"\\'")}')">${opt}</button>`).join('')}
                </div>`;
        }

        function answerQuiz(btn, selected, correct) {
            const buttons = document.querySelectorAll('.quiz-option');
            buttons.forEach(b => { b.disabled = true; b.style.pointerEvents = 'none'; });
            
            if (selected === correct) {
                btn.classList.add('correct');
                quizCorrect++;
            } else {
                btn.classList.add('wrong');
                buttons.forEach(b => { if (b.textContent === correct) b.classList.add('correct'); });
            }
            setTimeout(() => { quizIndex++; renderQuizQuestion(); }, 1200);
        }

        function showQuizResult() {
            const score = Math.round((quizCorrect / quizData.length) * 100);
            const scoreClass = score >= 80 ? 'excellent' : score >= 60 ? 'good' : 'poor';
            const message = score >= 80 ? 'Luar biasa! Anda menguasai kosakata ini!' :
                           score >= 60 ? 'Bagus! Terus berlatih untuk hasil lebih baik.' :
                           'Tetap semangat! Pelajari kosakata lagi dan coba lagi.';

            document.getElementById('quizContent').innerHTML = `
                <div class="quiz-result">
                    <div class="quiz-score ${scoreClass}">${score}%</div>
                    <div class="quiz-message">${message}</div>
                    <div style="font-size:14px;color:#888;margin-bottom:24px">Benar: ${quizCorrect} dari ${quizData.length} soal</div>
                    <button class="btn btn-primary" onclick="startQuiz(${currentCourseId})">&#128260; Coba Lagi</button>
                    <button class="btn btn-secondary" onclick="closeQuiz()" style="margin-left:8px">Tutup</button>
                </div>`;

            // Save result
            fetch('/language/api/quiz/submit', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ idCourse: currentCourseId, totalQuestions: quizData.length, correctAnswers: quizCorrect })
            });
        }

        function closeQuiz() {
            document.getElementById('quizContainer').classList.remove('show');
        }

        function closeModal(id) { document.getElementById(id).classList.remove('show'); }
        document.querySelectorAll('.modal-overlay').forEach(m => m.addEventListener('click', function(e) { if (e.target === this) this.classList.remove('show'); }));
    </script>
</body>
</html>
